<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fingerprintjs2@2.1.0/dist/fingerprint2.min.js"></script>
</head>
<body style="margin:0; overflow:hidden;">

  <!-- AR Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-marker type="pattern" url="marker.patt" id="login-marker" emitevents="true">
      <a-box id="ar-box" position="0 0.5 0" material="color: blue; opacity: 0.5;"></a-box>
      <a-text id="success-text" value="" color="lime" position="0 1 0" align="center" visible="false"></a-text>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const marker = document.getElementById("login-marker");
    const arBox = document.getElementById("ar-box");
    const successText = document.getElementById("success-text");
    const BACKEND = "https://pointed-filter-glasses-pay.trycloudflare.com";
    const USERNAME = "testuer"; // Replace with actual username or dynamic input

    async function getDeviceId() {
      return new Promise((resolve) => {
        Fingerprint2.get((components) => {
          const values = components.map((c) => c.value).join('');
          sha256(values).then(resolve);
        });
      });
    }

    function sha256(str) {
      const buffer = new TextEncoder("utf-8").encode(str);
      return crypto.subtle.digest("SHA-256", buffer).then((hash) => {
        return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, "0")).join("");
      });
    }

    async function createSession() {
      console.log("[AR] Creating session...");
      const res = await fetch(`${BACKEND}/create-session`, { method: "POST" });
      if (!res.ok) throw new Error("Failed to create session");
      return await res.json();
    }

    async function computeHMAC(sessionId, challenge, deviceId) {
      console.log("[AR] Computing HMAC...");
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw",
        encoder.encode("SUPER_HMAC_SECRET_456!"),
        { name: "HMAC", hash: "SHA-256" },
        false,
        ["sign"]
      );
      const data = encoder.encode(`${sessionId}:${challenge}:${deviceId}`);
      const signature = await crypto.subtle.sign("HMAC", key, data);
      return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function confirmSession(sessionId, username, hmac, deviceId) {
      console.log("[AR] Confirming session...");
      const res = await fetch(`${BACKEND}/confirm-session/${sessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, hmac, deviceId })
      });
      const data = await res.json();
      console.log("[AR] Confirm response:", data);
      return res.ok && data.status === "success";
    }

    async function getToken(sessionId) {
      console.log("[AR] Requesting token...");
      const res = await fetch(`${BACKEND}/session/${sessionId}/token`);
      const data = await res.json();
      console.log("[AR] Token received:", data.token);
      return data.token;
    }

    marker.addEventListener("markerFound", async () => {
      console.log("[AR] Marker detected");
      try {
        const deviceId = await getDeviceId();
        const session = await createSession();
        const hmac = await computeHMAC(session.sessionId, session.challenge, deviceId);
        const confirmed = await confirmSession(session.sessionId, USERNAME, hmac, deviceId);

        if (confirmed) {
          const token = await getToken(session.sessionId);
          localStorage.setItem("userToken", token);
          window.parent.postMessage({ type: "AR_LOGIN_SUCCESS", token }, "*");

          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");
        } else {
          console.warn("[AR] Session confirmation failed");
        }
      } catch (err) {
        console.error("[AR] Handshake error:", err);
      }
    });
  </script>
</body>
</html>
