<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }

    /* Full-page overlay */
    #login-overlay {
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      display:flex; justify-content:center; align-items:center;
      z-index:9999;
      display: none; /* initially hidden */
    }

    .login-box {
      background: rgba(255,255,255,0.95);
      padding: 40px 60px; border-radius:12px;
      text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.3);
    }

    .login-box input { display:block; width:200px; margin:10px auto; padding:8px; border-radius:5px; border:1px solid #ccc; }
    .login-box button { margin:10px 5px; padding:10px 16px; border:none; border-radius:5px; background:#28a745; color:white; cursor:pointer; }
    .login-box h2 { margin:0 0 20px; font-size:1.8rem; color:#333; }
    #login-message { margin-top:10px; font-size:0.9rem; color:red; }
    .marker-img { max-width: 150px; margin-bottom: 20px; display:block; margin-left:auto; margin-right:auto; }
  </style>
</head>

<body>
  <!-- AR Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-marker type="pattern" url="marker.patt" id="login-marker" emitevents="true">
      <a-box id="ar-box" position="0 0.5 0" material="color: blue; opacity: 0.5;"></a-box>
      <a-text id="success-text" value="" color="lime" position="0 1 0" align="center" visible="false"></a-text>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Login Overlay -->
  <div id="login-overlay">
    <div class="login-box">
      <img src="marker.png" alt="AR Marker" class="marker-img" />
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <div>
        <button id="login-btn">Login</button>
        <button id="register-btn">Register</button>
      </div>
      <div id="login-message"></div>
    </div>
  </div>

  <script>
    const marker = document.getElementById("login-marker");
    const loginOverlay = document.getElementById("login-overlay");
    const loginMessage = document.getElementById("login-message");
    const arBox = document.getElementById("ar-box");
    const successText = document.getElementById("success-text");

    const BACKEND = "https://betty-stack-improving-passengers.trycloudflare.com";

    // Show overlay when marker detected
    marker.addEventListener("markerFound", () => loginOverlay.style.display = "flex");
    marker.addEventListener("markerLost", () => loginOverlay.style.display = "none");

    // ---------------------------
    // VERIFY TOKEN
    // ---------------------------
    async function verifyUserToken(token) {
      try {
        const res = await fetch(`${BACKEND}/verify-token`, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (res.ok && data.username) {
          loginOverlay.style.display = "none";
          console.log("Overlay removed for user:", data.username);

          // AR feedback
          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");
          return true;
        }
        return false;
      } catch (err) {
        console.error("Token verification failed:", err);
        return false;
      }
    }

    // ---------------------------
    // ON PAGE LOAD â†’ CHECK TOKEN
    // ---------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("userToken");
      if (token) {
        const valid = await verifyUserToken(token);
        if (!valid) localStorage.removeItem("userToken");
      }
    });

    // ---------------------------
    // HANDLE LOGIN / REGISTER
    // ---------------------------
    async function handleAuth(action) {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!username || !password) {
        loginMessage.style.color = "red";
        loginMessage.textContent = "Enter both username and password";
        return;
      }

      try {
        const res = await fetch(`${BACKEND}/${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();

        if (res.ok && data.token) {
          localStorage.setItem("userToken", data.token);
          loginOverlay.style.display = "none";
          loginMessage.style.color = "green";
          loginMessage.textContent = data.message || "Success!";

          // AR feedback
          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");

          // optional: send token to parent
          window.parent.postMessage({ type: "AR_LOGIN_SUCCESS", token: data.token }, "*");
        } else {
          loginMessage.style.color = "red";
          loginMessage.textContent = data.detail || "Invalid credentials";
        }
      } catch (err) {
        console.error(err);
        loginMessage.style.color = "red";
        loginMessage.textContent = "Cannot reach server";
      }
    }

    document.getElementById("login-btn").addEventListener("click", () => handleAuth("login"));
    document.getElementById("register-btn").addEventListener("click", () => handleAuth("register"));
  </script>
</body>
</html>
