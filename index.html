<!doctype html>
<html>
<head>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body, html { margin:0; padding:0; overflow:hidden; font-family: Arial; }
    .overlay {
      position: fixed; top: 50%; left:50%; transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.7); color:#fff; padding: 20px; border-radius: 12px;
      width: 85%; max-width: 350px; display: none; z-index: 999;
    }
    input { width: 100%; padding: 8px; margin-top: 6px; border-radius:6px; border:none; }
    button { width: 100%; padding:10px; margin-top:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; background:#0ff; color:#000; }
    #login-msg, #reg-msg { margin-top:6px; font-size:13px; text-align:center; }
  </style>

  <script>
    const BACKEND = "https://hydraulic-subsidiaries-synthesis-simulation.trycloudflare.com"; // Change this
    let loginSuccess = false;

    function showOverlay() {
      document.getElementById("loginOverlay").style.display = "block";
    }

    async function registerUser() {
      const username = document.getElementById("reg-username").value.trim();
      const password = document.getElementById("reg-password").value.trim();
      const msg = document.getElementById("reg-msg");
      msg.innerHTML = "Registering..."; msg.style.color="#0ff";

      try {
        const res = await fetch(`${BACKEND}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok) { msg.innerHTML="Registered!"; msg.style.color="#0f0"; }
        else { msg.innerHTML = data.detail || "Error"; msg.style.color="#f00"; }
      } catch { msg.innerHTML="Server error"; msg.style.color="#f00"; }
    }

    async function loginUser() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();
      const msg = document.getElementById("login-msg");
      msg.innerHTML = "Logging in..."; msg.style.color="#0ff";

      try {
        const res = await fetch(`${BACKEND}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (res.ok) {
          msg.innerHTML = "Login successful!"; msg.style.color="#0f0";
          loginSuccess = true;
          localStorage.setItem("userToken", data.token);
          document.getElementById("loginOverlay").style.display="none";
        } else {
          msg.innerHTML = data.detail || "Login failed"; msg.style.color="#f00";
        }
      } catch { msg.innerHTML="Server error"; msg.style.color="#f00"; }
    }

    AFRAME.registerComponent('marker-ui-handler', {
      init: function () {
        const marker = this.el;
        const vid = document.querySelector("#vid");

        marker.addEventListener('markerFound', () => {
          if (!loginSuccess) showOverlay();
          else vid.play();
        });

        marker.addEventListener('markerLost', () => {
          vid.pause();
        });
      }
    });
  </script>
</head>

<body>

<!-- Hidden overlay, only appears after marker scan -->
<div class="overlay" id="loginOverlay">
  <div style="text-align:center;"><b>Register</b></div>
  <input id="reg-username" type="text" placeholder="Username" />
  <input id="reg-password" type="password" placeholder="Password" />
  <button onclick="registerUser()">Register</button>
  <div id="reg-msg"></div>

  <hr style="border:1px solid #0ff;margin:10px 0;">

  <div style="text-align:center;"><b>Login</b></div>
  <input id="login-username" type="text" placeholder="Username" />
  <input id="login-password" type="password" placeholder="Password" />
  <button onclick="loginUser()">Login</button>
  <div id="login-msg"></div>
</div>

<a-scene
  vr-mode-ui="enabled: false"
  loading-screen="enabled: false"
  arjs='sourceType: webcam; debugUIEnabled: false;'
  embedded
>
  <a-assets>
    <video id="vid" src="asset.mp4" preload="auto" loop muted playsinline></video>
  </a-assets>

  <a-marker type="pattern" url="marker.patt" marker-ui-handler>
    <a-video src="#vid" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0"></a-video>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

</body>
</html>
