<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }

    /* AR Overly */
    #login-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #login-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .login-box {
      background: rgba(255,255,255,0.9);
      padding: 40px 60px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .marker-img {
      max-width: 200px;
      width: 100%;
      display: block;
      margin: 0 auto 20px auto;
    }

    .login-box h2 {
      font-family: sans-serif;
      font-size: 1.8rem;
      color: #333;
      margin: 0;
    }
  </style>
</head>

<body>
  <!-- AR Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-marker type="pattern" url="marker.patt" id="login-marker" emitevents="true">
      <a-box id="ar-box" position="0 0.5 0" material="color: blue; opacity: 0.5;"></a-box>
      <a-text id="success-text" value="" color="lime" position="0 1 0" align="center" visible="false"></a-text>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Overlay -->
  <div id="login-overlay">
    <div class="login-box">
      <img src="marker.png" alt="AR Marker" class="marker-img" />
      <h2>Scan Marker to Login</h2>
    </div>
  </div>

  <script>
    const marker = document.getElementById("login-marker");
    const loginOverlay = document.getElementById("login-overlay");
    const arBox = document.getElementById("ar-box");
    const successText = document.getElementById("success-text");

    const BACKEND = "https://betty-stack-improving-passengers.trycloudflare.com";

    // Show overlay when marker detected
    marker.addEventListener("markerFound", () => loginOverlay.classList.remove("hidden"));
    marker.addEventListener("markerLost", () => loginOverlay.classList.add("hidden"));

    // ---------------------------
    // VERIFY TOKEN FUNCTION
    // ---------------------------
    async function verifyUserToken(token) {
      try {
        const res = await fetch(`${BACKEND}/verify-token`, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();

        if (res.ok && data.username) {
          loginOverlay.classList.add("hidden");
          console.log("Overlay removed for user:", data.username);

          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");
          return true;
        } else {
          console.warn("Invalid token");
          return false;
        }
      } catch (err) {
        console.error("Token verification failed:", err);
        return false;
      }
    }

    // ---------------------------
    // ON PAGE LOAD â†’ CHECK TOKEN
    // ---------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("userToken");
      if (token) {
        const valid = await verifyUserToken(token);
        if (!valid) localStorage.removeItem("userToken");
      }
    });

    // ---------------------------
    // LISTEN FOR AR SCENE SUCCESS (from phone)
    // ---------------------------
    window.addEventListener("message", async (event) => {
      if (event.data?.type === "AR_LOGIN_SUCCESS" && event.data.token) {
        const token = event.data.token;
        localStorage.setItem("userToken", token);
        const valid = await verifyUserToken(token);
        if (!valid) localStorage.removeItem("userToken");
      }
    });
  </script>
</body>
</html>
