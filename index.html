<!doctype html>
<html>
<head>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body, html { margin:0; padding:0; overflow:hidden; font-family: Arial; }
    .overlay {
      position: fixed; top: 50%; left:50%; transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.85); color:#fff; padding: 20px; border-radius: 12px;
      width: 85%; max-width: 350px; display: none; z-index: 999;
      text-align:center;
    }
    input { width: 100%; padding: 10px; margin-top: 10px; border-radius:6px; border:none; }
    button { width: 100%; padding:10px; margin-top:15px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; background:#0ff; color:#000; }
    #status-msg { margin-top:10px; font-size:14px; }
  </style>

  <script>
    const BACKEND_URL = "https://hydraulic-subsidiaries-synthesis-simulation.trycloudflare.com";
    let loginSuccess = false;

    function showOverlay() {
      document.getElementById("loginOverlay").style.display = "block";
    }

    function hideOverlay() {
      document.getElementById("loginOverlay").style.display = "none";
      console.log("[AR Overlay] Hidden");
    }

    function updateStatus(message, color="#0ff") {
      const msg = document.getElementById("status-msg");
      msg.textContent = message;
      msg.style.color = color;
      console.log("[AR Overlay]", message);
    }

    async function loginUser() {
      const username = document.getElementById("user-username").value.trim();
      const password = document.getElementById("user-password").value.trim();

      if(!username || !password) {
        updateStatus("Enter username & password", "orange");
        return;
      }

      updateStatus("Logging in...");

      try {
        const res = await fetch(`${BACKEND_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if(res.ok && data.token) {
          updateStatus("Login successful!", "lightgreen");
          loginSuccess = true;
          localStorage.setItem("arUserToken", data.token);
          hideOverlay();
        } else {
          updateStatus(data.detail || "Login failed", "red");
        }
      } catch (err) {
        updateStatus("Server error", "red");
        console.error(err);
      }
    }

    // Poll backend for AR token broadcast
    async function pollARTokens() {
      if(loginSuccess) return;

      try {
        const res = await fetch(`${BACKEND_URL}/latest-token`);
        const data = await res.json();
        if(data.token && !localStorage.getItem("arUserToken")) {
          console.log("[AR Overlay] Token detected:", data.token);
          localStorage.setItem("arUserToken", data.token);

          // Verify token
          const verifyRes = await fetch(`${BACKEND_URL}/verify-token`, {
            method:"POST",
            headers:{ "Authorization": "Bearer " + data.token }
          });
          const verifyData = await verifyRes.json();
          if(verifyRes.ok && verifyData.username) {
            updateStatus(`Welcome, ${verifyData.username}`, "lightgreen");
            loginSuccess = true;
            hideOverlay();
          } else {
            updateStatus("Invalid token", "red");
            localStorage.removeItem("arUserToken");
          }
        }
      } catch(err) { console.error(err); }
    }

    setInterval(pollARTokens, 3000);

    // AR Marker handler
    AFRAME.registerComponent('marker-ui-handler', {
      init: function () {
        const marker = this.el;
        const vid = document.querySelector("#vid");

        marker.addEventListener('markerFound', () => {
          if(!loginSuccess) showOverlay();
          else vid.play();
        });
        marker.addEventListener('markerLost', () => { vid.pause(); });
      }
    });
  </script>
</head>

<body>

<!-- Single login form overlay -->
<div class="overlay" id="loginOverlay">
  <h2>AR Login</h2>
  <input id="user-username" type="text" placeholder="Username" />
  <input id="user-password" type="password" placeholder="Password" />
  <button onclick="loginUser()">Login</button>
  <div id="status-msg">Scan the marker to begin</div>
</div>

<a-scene vr-mode-ui="enabled:false" loading-screen="enabled:false"
         arjs="sourceType: webcam; debugUIEnabled: false;" embedded>
  <a-assets>
    <video id="vid" src="asset.mp4" preload="auto" loop muted playsinline></video>
  </a-assets>

  <a-marker type="pattern" url="marker.patt" marker-ui-handler>
    <a-video src="#vid" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0"></a-video>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

</body>
</html>
