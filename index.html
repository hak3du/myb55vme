<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fingerprintjs2@2.1.0/dist/fingerprint2.min.js"></script>
</head>
<body style="margin:0; overflow:hidden;">

  <!-- AR Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-marker type="pattern" url="marker.patt" id="login-marker" emitevents="true">
      <a-box id="ar-box" position="0 0.5 0" material="color: blue; opacity: 0.5;"></a-box>
      <a-text id="success-text" value="" color="lime" position="0 1 0" align="center" visible="false"></a-text>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const marker = document.getElementById("login-marker");
    const arBox = document.getElementById("ar-box");
    const successText = document.getElementById("success-text");
    const BACKEND = "https://pointed-filter-glasses-pay.trycloudflare.com";

    async function getDeviceId() {
      return new Promise((resolve) => {
        Fingerprint2.get((components) => {
          const values = components.map((c) => c.value).join('');
          const hash = sha256(values);
          resolve(hash);
        });
      });
    }

    function sha256(str) {
      const buffer = new TextEncoder("utf-8").encode(str);
      return crypto.subtle.digest("SHA-256", buffer).then((hash) => {
        return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, "0")).join("");
      });
    }

    async function createSession() {
      const res = await fetch(`${BACKEND}/create-session`, { method: "POST" });
      if (!res.ok) throw new Error("Failed to create session");
      return await res.json();
    }

    async function computeHMAC(sessionId, challenge, deviceId) {
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw",
        encoder.encode("SUPER_HMAC_SECRET_456!"),
        { name: "HMAC", hash: "SHA-256" },
        false,
        ["sign"]
      );
      const data = encoder.encode(`${sessionId}:${challenge}:${deviceId}`);
      const signature = await crypto.subtle.sign("HMAC", key, data);
      return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function confirmSession(sessionId, token, hmac, deviceId) {
      const res = await fetch(`${BACKEND}/confirm-session/${sessionId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ hmac, deviceId })
      });
      const data = await res.json();
      return res.ok && data.status === "success";
    }

    async function verifyUserToken(token) {
      try {
        const res = await fetch(`${BACKEND}/verify-token`, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (res.ok && data.username) {
          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");
          return true;
        }
      } catch (err) {
        console.error("verifyUserToken error:", err);
      }
      return false;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("userToken");
      if (token) {
        const valid = await verifyUserToken(token);
        if (!valid) {
          localStorage.removeItem("userToken");
        }
      }
    });

    marker.addEventListener("markerFound", async () => {
      try {
        const token = localStorage.getItem("userToken");
        if (!token) return;
        const deviceId = await getDeviceId();
        const session = await createSession();
        const hmac = await computeHMAC(session.sessionId, session.challenge, deviceId);
        const confirmed = await confirmSession(session.sessionId, token, hmac, deviceId);
        if (confirmed) {
          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");
        }
      } catch (err) {
        console.error("Handshake error:", err);
      }
    });
  </script>
</body>
</html>
