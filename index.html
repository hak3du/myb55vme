<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin:0; overflow:hidden;">

  <!-- AR -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-marker type="pattern" url="marker.patt" id="login-marker" emitevents="true">
      <a-box id="ar-box" position="0 0.5 0" material="color: blue; opacity: 0.5;"></a-box>
      <a-text id="success-text" value="" color="lime" position="0 1 0" align="center" visible="false"></a-text>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <!-- UI Buttons -->
  <div id="auth-ui" style="display: none; position: fixed; top: 20px; left: 20px; z-index: 9999; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px;">
    <input type="text" id="username" placeholder="Username" style="margin-bottom: 5px; width: 100%;" />
    <input type="password" id="password" placeholder="Password" style="margin-bottom: 10px; width: 100%;" />
    <button onclick="registerUser()">Register</button>
    <button onclick="loginUser()">Login</button>
  </div>

  <script>
    const BACKEND = "gene-incurred-sacred-eng.trycloudflare.com";
    const arBox = document.getElementById("ar-box");
    const successText = document.getElementById("success-text");
    const authUI = document.getElementById("auth-ui");
    const marker = document.getElementById("login-marker");

    marker.addEventListener("markerFound", () => {
      console.log("[AR] Marker found â€” showing login/register UI");
      authUI.style.display = "block";
    });

    marker.addEventListener("markerLost", () => {
      console.log("[AR] Marker lost â€” hiding login/register UI");
      authUI.style.display = "none";
    });

    async function registerUser() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) return alert("Please enter both fields");

      try {
        const res = await fetch(`${BACKEND}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok) {
          alert("Registration successful");
        } else {
          alert(data.detail || "Registration failed");
        }
      } catch (err) {
        console.error("Register error:", err);
        alert("Error registering user");
      }
    }

    async function loginUser() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) return alert("Please enter both fields");

      try {
        const res = await fetch(`${BACKEND}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok && data.token) {
          localStorage.setItem("userToken", data.token);
          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");

          // ðŸ”¹ Broadcast token to backend
          await fetch(`${BACKEND}/broadcast-token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: data.token,
              device: navigator.userAgent,
              timestamp: Date.now()
            })
          });

          console.log("[AR] Token broadcasted to backend");
        } else {
          alert(data.detail || "Login failed");
        }
      } catch (err) {
        console.error("Login error:", err);
        alert("Error logging in");
      }
    }
  </script>
</body>
</html>
