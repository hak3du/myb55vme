<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>AHE — Instant AR Login</title>

  <!-- A-Frame & AR.js (CN) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.min.js"></script>

  <style>
    /* Page reset */
    html,body { margin:0; padding:0; height:100%; background:#000; -webkit-font-smoothing:antialiased; }
    /* The AR scene sits full-viewport behind UI */
    #ar-scene { position:fixed; inset:0; width:100%; height:100%; z-index:1; }

    /* Compact centered overlay (optional) - keep above AR scene */
    #login-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* allow clicks through except inner panels */
      z-index: 10;
    }

    /* AR panel shown when marker detected */
    .ar-panel {
      pointer-events: auto;
      width: 86%;
      max-width: 360px;
      background: rgba(12,12,14,0.95);
      color: #eef;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      transform-origin: center;
      transition: transform 0.28s ease, opacity 0.28s ease;
      opacity: 0;
      transform: translateY(8px) scale(0.98);
    }
    .ar-panel.visible { opacity: 1; transform: translateY(0) scale(1); }

    .ar-panel h3 { margin: 0 0 8px 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto; font-weight:600; font-size:18px; }
    .ar-panel p { margin:0 0 12px 0; font-size:13px; color:#bfe; }

    .btn {
      display:inline-block;
      padding:10px 14px;
      border-radius:10px;
      background: linear-gradient(135deg,#07c,#05a);
      color:#fff;
      border:none;
      font-weight:600;
      cursor:pointer;
    }

    /* Compact modal login form */
    #ar-login-modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(0.98);
      width: 92%;
      max-width: 420px;
      background: #0b0b0b;
      color: #dff;
      padding: 18px;
      border-radius: 12px;
      z-index: 30;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      display: none;
    }
    #ar-login-modal.visible { display:block; }

    #ar-login-modal label { display:block; font-size:13px; margin-top:8px; color:#bfe; }
    #ar-login-modal input {
      width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02); color:#fff;
    }

    #status-bar {
      position: fixed;
      left: 14px;
      bottom: 14px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.6);
      color:#dff;
      border-radius: 10px;
      font-size:13px;
      z-index: 20;
    }

    /* small helper when camera blocked */
    .camera-warning { color:#ffb; font-size:13px; margin-top:10px; }
  </style>
</head>
<body>

  <!-- AR scene -->
  <a-scene
    id="ar-scene"
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; antialias: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">
    
    <!-- Use hiro marker for instant demo. Replace with custom marker/pattern if you have one. -->
    <a-marker preset="hiro" id="ar-marker">
      <!-- simple 3D hint while marker is visible -->
      <a-box position="0 0.35 0" rotation="0 45 0" material="opacity:0.9; shader: standard; color: #3dd" scale="0.5 0.5 0.5"></a-box>
      <a-text value="AHE LOGIN" align="center" position="0 0.95 0" width="2"></a-text>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- HTML overlay UI (not fullscreen) -->
  <div id="login-overlay" aria-hidden="false">
    <div id="ar-panel" class="ar-panel" role="dialog" aria-label="AR login panel">
      <h3>Augmented Login</h3>
      <p id="panel-msg">Point your camera at the AR marker to begin</p>
      <button id="auth-btn" class="btn">Authenticate in AR</button>
      <div id="panel-sub" style="margin-top:10px;font-size:12px;color:#bfe"></div>
    </div>
  </div>

  <!-- Compact modal login (shown on pressing Authenticate) -->
  <div id="ar-login-modal" role="dialog" aria-modal="true" aria-label="AR login form">
    <h3>Login (AR)</h3>
    <form id="ar-login-form">
      <label for="u">Username</label>
      <input id="u" name="username" type="text" autocomplete="username" required />
      <label for="p">Password</label>
      <input id="p" name="password" type="password" autocomplete="current-password" required />
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
        <button type="button" id="cancel-login" class="btn" style="background:rgba(100,100,100,0.6)">Cancel</button>
        <button type="submit" id="submit-login" class="btn">Log in</button>
      </div>
      <div id="login-error" style="margin-top:10px;color:#f88;font-size:13px"></div>
    </form>
  </div>

  <div id="status-bar">AR: waiting for marker…</div>

  <script>
    (function(){
      const BACKEND = "https://hydraulic-subsidiaries-synthesis-simulation.trycloudflare.com"; // <-- update if needed
      const markerEl = document.getElementById("ar-marker");
      const panel = document.getElementById("ar-panel");
      const panelMsg = document.getElementById("panel-msg");
      const authBtn = document.getElementById("auth-btn");
      const statusBar = document.getElementById("status-bar");
      const loginModal = document.getElementById("ar-login-modal");
      const loginForm = document.getElementById("ar-login-form");
      const loginError = document.getElementById("login-error");
      const cancelBtn = document.getElementById("cancel-login");
      let markerVisible = false;

      function setStatus(msg){
        statusBar.textContent = "AR: " + msg;
        console.log("[AR SCENE] " + msg);
      }

      // marker found / lost events
      markerEl.addEventListener("markerFound", () => {
        markerVisible = true;
        panel.classList.add("visible");
        panelMsg.textContent = "Marker detected. Tap Authenticate to login.";
        setStatus("marker found");
      });

      markerEl.addEventListener("markerLost", () => {
        markerVisible = false;
        panel.classList.remove("visible");
        panelMsg.textContent = "Point your camera at the AR marker to begin";
        setStatus("marker lost");
      });

      // show login modal when pressing Authenticate
      authBtn.addEventListener("click", () => {
        if (!markerVisible) {
          panelMsg.textContent = "No marker visible — point camera at marker.";
          return;
        }
        loginError.textContent = "";
        loginModal.classList.add("visible");
      });

      cancelBtn.addEventListener("click", () => {
        loginModal.classList.remove("visible");
      });

      // perform login -> broadcast token -> postMessage to parent
      loginForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        loginError.textContent = "";
        const username = document.getElementById("u").value.trim();
        const password = document.getElementById("p").value;

        if (!username || !password) {
          loginError.textContent = "Enter username & password.";
          return;
        }

        setStatus("authenticating...");
        try {
          const res = await fetch(BACKEND + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
          });

          if (!res.ok) {
            const err = await res.json().catch(()=>({detail:"login failed"}));
            loginError.textContent = err.detail || "Login failed";
            setStatus("login failed");
            return;
          }

          const data = await res.json();
          const token = data.token;
          if (!token) {
            loginError.textContent = "No token received from server.";
            setStatus("no token");
            return;
          }

          // Broadcast token to backend bridge (latest-token)
          await fetch(BACKEND + "/broadcast-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token,
              device: navigator.userAgent || "unknown",
              timestamp: new Date().toISOString()
            })
          });

          setStatus("token broadcasted");

          // Notify the parent (overlay) if present on same page
          window.postMessage({ type: "AR_LOGIN_SUCCESS", token }, "*");

          // Optionally close modal and show success UI for user
          loginModal.classList.remove("visible");
          panelMsg.textContent = "Login successful — enjoy AHE.";
          setTimeout(() => {
            panelMsg.textContent = "Point your camera at the AR marker to begin";
          }, 2000);

        } catch (err) {
          console.error("Login error:", err);
          loginError.textContent = "Network error — try again.";
          setStatus("network error");
        }
      });

      // camera permission detection
      async function testCamera() {
        try {
          // This call will prompt for camera permission in many browsers
          await navigator.mediaDevices.getUserMedia({ video: true });
          setStatus("camera ready — point at marker");
        } catch (err) {
          console.warn("Camera failed:", err);
          setStatus("camera permission required");
          const msg = document.createElement("div");
          msg.className = "camera-warning";
          msg.textContent = "Allow camera permission for AR to work. Reload if needed.";
          panel.appendChild(msg);
        }
      }
      // run check once
      testCamera();

      // Expose a debugging helper to manually simulate marker found (dev)
      window.__simulateARMarker = function(){
        const ev = new Event("markerFound");
        markerEl.dispatchEvent(ev);
      };

    })();
  </script>
</body>
</html>
