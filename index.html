<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AR Login Scene</title>

  <!-- A-Frame & AR.js -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    /* General body */
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* AR Login Overlay */
    #ar-login {
      position: absolute;
      z-index: 9999;
      display: none;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 30px 40px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    #ar-login h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
      color: #333;
    }

    #ar-login input {
      display: block;
      width: 220px;
      margin: 10px auto;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    #ar-login button {
      margin: 10px 5px 0 5px;
      padding: 10px 16px;
      border-radius: 5px;
      border: none;
      background-color: #28a745;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    #login-message {
      margin-top: 10px;
      font-size: 0.9rem;
      color: red;
    }
  </style>
</head>

<body>

  <!-- AR Scene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-marker type="pattern" url="marker.patt" id="login-marker" emitevents="true">
      <a-box id="ar-box" position="0 0.5 0" material="color: blue; opacity: 0.5;"></a-box>
      <a-text id="success-text" value="" color="lime" position="0 1 0" align="center" visible="false"></a-text>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- AR Login Overlay -->
  <div id="ar-login">
    <h2>Authentication</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <div>
      <button id="login-btn">Login</button>
      <button id="register-btn">Register</button>
    </div>
    <div id="login-message"></div>
  </div>

  <script>
    // Elements
    const marker = document.getElementById("login-marker");
    const loginOverlay = document.getElementById("ar-login");
    const loginMessage = document.getElementById("login-message");
    const arBox = document.getElementById("ar-box");
    const successText = document.getElementById("success-text");

    // Marker events
    marker.addEventListener("markerFound", () => {
      console.log("✅ Marker detected");
      loginOverlay.style.display = "block";
    });
    marker.addEventListener("markerLost", () => {
      console.log("❌ Marker lost");
      loginOverlay.style.display = "none";
    });

    // Backend URL
    const API_BASE = "https://betty-stack-improving-passengers.trycloudflare.com";

    // -------------------------
    // Handle login/register
    // -------------------------
    async function handleAuth(action) {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!username || !password) {
        loginMessage.style.color = "red";
        loginMessage.textContent = "Please enter both username and password.";
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();

        if (res.ok && data.token) {
          loginMessage.style.color = "green";
          loginMessage.textContent = data.message || "Success!";
          loginOverlay.style.display = "none";

          // Save token
          localStorage.setItem("userToken", data.token);

          // Send to parent window for AR integration
          window.parent.postMessage({ type: "AR_LOGIN_SUCCESS", token: data.token }, "*");

          // AR Feedback
          arBox.setAttribute("color", "lime");
          successText.setAttribute("value", "Access Granted");
          successText.setAttribute("visible", "true");
        } else {
          loginMessage.style.color = "red";
          loginMessage.textContent = data.detail || "Error occurred";
        }
      } catch (err) {
        console.error("Login/Register Error:", err);
        loginMessage.style.color = "red";
        loginMessage.textContent = "Cannot reach server. Try again.";
      }
    }

    // Event listeners
    document.getElementById("login-btn").addEventListener("click", () => handleAuth("login"));
    document.getElementById("register-btn").addEventListener("click", () => handleAuth("register"));
  </script>
</body>
</html>
